name: Build All Platforms & Deploy

on:
  push:
    branches: ["tauri-migration"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "deploy-all"
  cancel-in-progress: true

jobs:
  build-desktop:
    name: Build Desktop Apps
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: linux
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-intel
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-apple-silicon
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install Dependencies
        run: npm install

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update
          sudo apt install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install macOS Dependencies
        if: matrix.os == 'macos-latest'
        run: |
          # Install genisoimage for DMG creation
          brew install genisoimage || echo "genisoimage already installed or not needed"

      - name: Debug Build Environment
        run: |
          echo "OS: ${{ matrix.os }}"
          echo "Target: ${{ matrix.target }}"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "Rust version: $(rustc --version)"
          echo "Cargo version: $(cargo --version)"
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            echo "macOS version: $(sw_vers)"
            echo "Available disk space: $(df -h)"
          fi
        shell: bash

      - name: Build Tauri App
        run: |
          # Build based on platform
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            npx tauri build --target ${{ matrix.target }} --bundles deb,appimage
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            npx tauri build --target ${{ matrix.target }} --bundles nsis,msi
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            npx tauri build --target ${{ matrix.target }} --bundles app
          fi
        shell: bash

      - name: Build DMG (macOS only)
        if: matrix.os == 'macos-latest'
        run: |
          # Try to build DMG, but don't fail the entire job if it fails
          echo "Attempting to build DMG..."
          if npx tauri build --target ${{ matrix.target }} --bundles dmg; then
            echo "DMG build successful"
          else
            echo "DMG build failed, but continuing with app bundle"
            ls -la src-tauri/target/${{ matrix.target }}/release/bundle/ || echo "No bundle directory found"
          fi
        continue-on-error: true
        shell: bash

      - name: List Build Output
        run: |
          echo "Build output structure:"
          find src-tauri/target/${{ matrix.target }}/release/bundle -type f -name "*" 2>/dev/null | head -20 || echo "No bundle files found"
        shell: bash

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-build
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle
            !**/*.dSYM
          if-no-files-found: warn

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install Dependencies
        run: npm install

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Android Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/cache
            ~/.gradle/caches
            ~/.gradle/wrapper
            src-tauri/gen/android/.gradle
          key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-android-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Android Rust Targets
        run: |
          rustup target add aarch64-linux-android armv7-linux-androideabi i686-linux-android x86_64-linux-android

      - name: Setup Android NDK
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.2.12479018" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/27.2.12479018" >> $GITHUB_ENV

      - name: Install Android NDK
        run: |
          sdkmanager "ndk;27.2.12479018"

      - name: Initialize Android Project
        run: |
          # Remove existing Android project to avoid package name conflicts
          if [ -d "src-tauri/gen/android" ]; then
            echo "Removing existing Android project to avoid package conflicts..."
            rm -rf src-tauri/gen/android
          fi
          echo "Initializing Android project..."
          npx tauri android init

      - name: Build Android APK
        run: npx tauri android build --apk

      - name: List Android Build Output
        run: |
          echo "Contents of src-tauri/gen/android/app/build/outputs/apk:"
          find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" -type f || echo "No APK files found"

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            src-tauri/gen/android/app/build/outputs/apk/**/*.apk

  web:
    name: Build Web & Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-desktop, build-android]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build web
        run: npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./dist"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  release:
    name: Release to GitHub
    runs-on: ubuntu-latest
    needs: [build-desktop, build-android]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Zip all builds
        run: |
          cd artifacts
          for dir in *; do
            zip -r "../${dir}.zip" "$dir"
          done

      - name: Generate release tag
        id: tag
        run: |
          # Create a timestamp-based tag
          TAG="v$(date +'%Y.%m.%d')-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ steps.tag.outputs.tag }}"
          tag_name: ${{ steps.tag.outputs.tag }}
          body: |
            Automated release from commit ${{ github.sha }}

            ## Changes
            - Built for all platforms (Windows, macOS, Linux, Android)
            - Web deployment to GitHub Pages

            ## Downloads
            - **Windows**: Download `windows-build.zip`
            - **macOS (Intel)**: Download `macos-intel-build.zip`
            - **macOS (Apple Silicon)**: Download `macos-apple-silicon-build.zip`
            - **Linux**: Download `linux-build.zip`
            - **Android**: Download `android-build.zip`
          files: |
            *.zip
          draft: false
          prerelease: false
